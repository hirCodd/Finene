import{_ as n,W as s,X as a,a1 as t}from"./framework-b468b75a.js";const p={},e=t(`<h2 id="_1-前言" tabindex="-1"><a class="header-anchor" href="#_1-前言" aria-hidden="true">#</a> 1.前言</h2><p>Apache ShenYu是一款支持多语言、多协议(Dubbo,SpringCloud,gRPC,Motan,SofaTars, BRPC)、插件化设计、高度可动态化配置、高度可自主化开发的Java网关。内置丰富的插件支持，鉴权，限流，熔断，防火墙等等。流量配置动态化，性能极高。支持集群部署，支持 A/B Test，蓝绿发布等功能。</p><p>Sentinel是阿里巴巴开源的一款流量控制组件，主要用于流量控制、熔断降级、系统负载保护等。本文将介绍如何在Apache ShenYu中整合Sentinel的源码分析。</p><h2 id="_2-apache-shenyu整合sentinel源码分析" tabindex="-1"><a class="header-anchor" href="#_2-apache-shenyu整合sentinel源码分析" aria-hidden="true">#</a> 2.Apache ShenYu整合Sentinel源码分析</h2><h3 id="_2-1-如何设置sentinel加载资源的resourcename" tabindex="-1"><a class="header-anchor" href="#_2-1-如何设置sentinel加载资源的resourcename" aria-hidden="true">#</a> 2.1 如何设置Sentinel加载资源的resourceName</h3><p>ShenYu通过rule中获取selectorId和ruleId,拼接成selectorId_ruleId形式的resourceName，例如：150232_1233</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getKey</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">RuleData</span> ruleData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">,</span> ruleData<span class="token punctuation">.</span><span class="token function">getSelectorId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ruleData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-1-sentinel加载shenyu配置的限流、降级规则" tabindex="-1"><a class="header-anchor" href="#_2-1-sentinel加载shenyu配置的限流、降级规则" aria-hidden="true">#</a> 2.1 Sentinel加载ShenYu配置的限流、降级规则</h3><p>ShenYu通过<code>org.apache.shenyu.plugin.sentinel.handler.SentinelRuleHandle</code>接收插件所配置的限流、降级规则，然后通过<code>org.apache.shenyu.plugin.sentinel.handler.SentinelRuleHandle#handlerRule</code>方法将规则加载到Sentinel中。</p><p>ShenYu会首先从Sentinel中获取流控、降级规则，然后将ShenYu配置的规则添加到Sentinel中，最后将所有规则加载到Sentinel中。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SentinelRuleHandle</span> <span class="token keyword">implements</span> <span class="token class-name">PluginDataHandler</span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerRule</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">RuleData</span> ruleData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SentinelHandle</span> sentinelHandle <span class="token operator">=</span> <span class="token class-name">GsonUtils</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>ruleData<span class="token punctuation">.</span><span class="token function">getHandle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">SentinelHandle</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sentinelHandle<span class="token punctuation">.</span><span class="token function">checkData</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">CacheKeyUtils</span><span class="token punctuation">.</span><span class="token constant">INST</span><span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span>ruleData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取当前资源的流控规则</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">&gt;</span></span> flowRules <span class="token operator">=</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">getRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getFlowRuleEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">SENTINEL_ENABLE_FLOW_RULE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">FlowRule</span> rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getFlowRuleCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getFlowRuleGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setControlBehavior</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getFlowRuleControlBehavior</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setMaxQueueingTimeMs</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getFlowRuleMaxQueueingTimeMs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setWarmUpPeriodSec</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getFlowRuleWarmUpPeriodSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            flowRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 加载流控规则</span>
        <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>flowRules<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 获取当前资源的降级规则</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DegradeRule</span><span class="token punctuation">&gt;</span></span> degradeRules <span class="token operator">=</span> <span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">getRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token operator">!</span>r<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getDegradeRuleEnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">SENTINEL_ENABLE_DEGRADE_RULE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DegradeRule</span> rule <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DegradeRule</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setCount</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getDegradeRuleCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setGrade</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getDegradeRuleGrade</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setTimeWindow</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getDegradeRuleTimeWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setStatIntervalMs</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getDegradeRuleStatIntervals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setMinRequestAmount</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getDegradeRuleMinRequestAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rule<span class="token punctuation">.</span><span class="token function">setSlowRatioThreshold</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getDegradeRuleSlowRatioThreshold</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            degradeRules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 加载降级规则</span>
        <span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">loadRules</span><span class="token punctuation">(</span>degradeRules<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-2-shenyu是如何获取应用错误并进行流控、降级的" tabindex="-1"><a class="header-anchor" href="#_2-2-shenyu是如何获取应用错误并进行流控、降级的" aria-hidden="true">#</a> 2.2 ShenYu是如何获取应用错误并进行流控、降级的</h3><h4 id="_2-2-1-在exchange注册http状态码消费者-何时消费" tabindex="-1"><a class="header-anchor" href="#_2-2-1-在exchange注册http状态码消费者-何时消费" aria-hidden="true">#</a> 2.2.1 在exchange注册http状态码消费者？何时消费？</h4><p>这个http状态码的消费者主要作用就是根据响应码抛出SentinelFallbackException，而<code>SentinelFallbackExceptio</code>n就是相当于收集来自原应用端的异常信息。</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">WATCHER_HTTP_STATUS</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpStatus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> status <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">is2xxSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SentinelFallbackException</span><span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span> <span class="token operator">:</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-2-1-shenyu是如何将应用资源交予sentinel管理的" tabindex="-1"><a class="header-anchor" href="#_2-2-1-shenyu是如何将应用资源交予sentinel管理的" aria-hidden="true">#</a> 2.2.1 ShenYu是如何将应用资源交予Sentinel管理的</h4><p><code>chain.execute(exchange).transform(new SentinelReactorTransformer&lt;&gt;(resourceName))</code>,其中的transform方法就是ShenYu将应用资源交予Sentinel的实现。 其中<code>new SentinelReactorTransformer&lt;&gt;(resourceName)</code>相当于sentinel的<code>Entry entry = SphU.entry(&quot;HelloWorld&quot;)</code></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>exchange<span class="token punctuation">.</span><span class="token function">getAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">WATCHER_HTTP_STATUS</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpStatus</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> status <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>status<span class="token punctuation">.</span><span class="token function">is2xxSuccessful</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SentinelFallbackException</span><span class="token punctuation">(</span>status <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">INTERNAL_SERVER_ERROR</span> <span class="token operator">:</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SentinelReactorTransformer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>resourceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>throwable <span class="token operator">-&gt;</span>
        fallbackHandler<span class="token punctuation">.</span><span class="token function">fallback</span><span class="token punctuation">(</span>exchange<span class="token punctuation">,</span> <span class="token class-name">UriUtils</span><span class="token punctuation">.</span><span class="token function">createUri</span><span class="token punctuation">(</span>sentinelHandle<span class="token punctuation">.</span><span class="token function">getFallbackUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="" tabindex="-1"><a class="header-anchor" href="#" aria-hidden="true">#</a></h4>`,19),c=[e];function o(l,u){return s(),a("div",null,c)}const k=n(p,[["render",o],["__file","ApacheShenYu-sentinel.html.vue"]]);export{k as default};
